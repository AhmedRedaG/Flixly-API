<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/upload.css" />
    <style>
      .video-page {
        display: grid;
        gap: 18px;
        grid-template-columns: 1fr;
      }
      .video-player {
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .meta {
        display: grid;
        gap: 8px;
      }
      .meta .title {
        font-size: 22px;
        font-weight: 700;
      }
      .meta .sub {
        font-size: 13px;
        color: var(--muted);
      }
      .channel {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 6px;
      }
      .channel img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border);
      }
      .tags {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .tag {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--muted);
      }
      .desc {
        white-space: pre-wrap;
        background: #0d1320;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        color: #d1d5db;
      }
      .comments {
        display: grid;
        gap: 12px;
      }
      .comment {
        display: grid;
        gap: 6px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0d1320;
      }
      .comment .user {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
      }
      .comment .user img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="container">
        <h1>Flixly</h1>
      </div>
    </header>
    <main class="container video-page">
      <% if (!video) { %>
      <section class="card">
        <h2>Video not found</h2>
        <p class="sub">The requested video could not be located.</p>
      </section>
      <% } else { %>
      <section class="video-player">
        <% if (video.url) { %>
        <video
          src="<%= video.url %>"
          controls
          preload="metadata"
          style="width: 100%; height: auto; display: block"
        ></video>
        <% } else { %>
        <div style="padding: 24px; color: var(--muted)">
          No video URL available.
        </div>
        <% } %>
      </section>
      <section class="card meta">
        <div class="title"><%= video.title %></div>
        <div class="sub">
          <%= video.views_count %> views ‚Ä¢ <%= new
          Date(video.created_at).toLocaleString() %>
        </div>
        <div
          style="display: flex; gap: 10px; align-items: center; margin: 6px 0"
        >
          <button id="likeBtn" class="btn" data-video-id="<%= video.id %>">
            üëç Like (<span id="likesCount"><%= video.likes_count %></span>)
          </button>
          <button id="dislikeBtn" class="btn" data-video-id="<%= video.id %>">
            üëé Dislike (<span id="dislikesCount"
              ><%= video.dislikes_count %></span
            >)
          </button>
          <input
            id="accessTokenReact"
            placeholder="Bearer <access_token>"
            style="flex: 1; max-width: 420px"
          />
        </div>
        <div class="channel">
          <img
            src="<%= video.channel?.avatar || 'https://via.placeholder.com/64' %>"
            alt="avatar"
          />
          <div>
            <div>
              <strong><%= video.channel?.name || 'Unknown Channel' %></strong>
            </div>
            <div class="sub">@<%= video.channel?.username %></div>
          </div>
        </div>
        <% if (video.tags?.length) { %>
        <div class="tags">
          <% video.tags.forEach(t => { %>
          <span class="tag">#<%= t.name %></span>
          <% }) %>
        </div>
        <% } %> <% if (video.description) { %>
        <div class="desc"><%= video.description %></div>
        <% } %>
      </section>
      <section class="card comments">
        <h2>Comments (<%= video.comments_count %>)</h2>
        <% if (!comments.length) { %>
        <div class="sub">No comments yet.</div>
        <% } %> <% comments.forEach(c => { %>
        <article class="comment">
          <div class="user">
            <img
              src="<%= c.user?.avatar || 'https://via.placeholder.com/56' %>"
              alt="user"
            />
            <div>
              <strong><%= c.user?.username || 'User' %></strong> ‚Ä¢ <%= new
              Date(c.created_at).toLocaleString() %>
            </div>
          </div>
          <div class="content"><%= c.content %></div>
        </article>
        <% }) %>
      </section>
      <% } %>
    </main>
  </body>
  <script>
    async function react(type) {
      const videoId = document.getElementById(type + "Btn").dataset.videoId;
      const token = (
        document.getElementById("accessTokenReact").value || ""
      ).trim();
      try {
        const res = await fetch(`/api/v1/videos/${videoId}/` + type, {
          method: "POST",
          headers: token ? { Authorization: token } : {},
        });
        const data = await res.json();
        if (res.ok && data && data.status === "success") {
          document.getElementById("likesCount").textContent =
            data.data.likes_count;
          document.getElementById("dislikesCount").textContent =
            data.data.dislikes_count;
        } else {
          alert(data?.data?.message || data?.message || "Action failed");
        }
      } catch (e) {
        console.error(e);
      }
    }
    document
      .getElementById("likeBtn")
      ?.addEventListener("click", () => react("like"));
    document
      .getElementById("dislikeBtn")
      ?.addEventListener("click", () => react("dislike"));
  </script>
</html>
